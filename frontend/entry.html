<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Add / Edit Entry</title>
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <header class="container">
            <h1 id="formTitle">Add New Entry</h1>
            <label class="theme-toggle">
                <input type="checkbox" id="darkModeToggle" />
                <span>Dark Mode</span>
            </label>
        </header>

        <main class="container">
            <!-- Current user and Logout button -->
            <div id="accountWidget" style="float:right; gap:.5rem; align-items:center;">
                <span id="acctEmail" style="opacity:.8"></span>
                </br>
                <button id="logoutBtn" type="button">Logout</button>
            </div>
            <!-- Shared form for both Add and Edit -->
            <form id="mediaForm">
                <!-- Title (required) -->
                <label for="title">Title</label>
                <input type="text" id="title" placeholder="Title" required />

                <!-- Type -->
                <label for="type">Type</label>
                <select id="type">
                    <option value="movie">Movie</option>
                    <option value="series">Series</option>
                </select>

                <!-- SubType -->
                 <label for="subType">SubType</label>
                <select id="subType">
                    <option value="anime">Anime</option>
                    <option value="live-action">Live Action</option>
                    <option value="animated">Animated</option>
                    <option value="documentary">Documentary</option>
                    <option value="manga">Manga</option>
                </select>

                <!-- Genres (pill-checkbox UI styled in css) -->
                <fieldset id="genreContainer" class="tag-pills">
                    <legend>Genres</legend>
                    <label><input type="checkbox" value="action">Action</label>
                    <label><input type="checkbox" value="adventure">Adventure</label>
                    <label><input type="checkbox" value="comedy">Comedy</label>
                    <label><input type="checkbox" value="drama">Drama</label>
                    <label><input type="checkbox" value="fantasy">Fantasy</label>
                    <label><input type="checkbox" value="romance">Romance</label>
                    <label><input type="checkbox" value="sci-fi">Sci-Fi</label>
                    <label><input type="checkbox" value="horror">Horror</label>
                    <label><input type="checkbox" value="mystery">Mystery</label>
                </fieldset>

                <!-- Status -->
                <label for="status">Status</label>
                <select id="status">
                    <option value="watching">Watching / Reading</option>
                    <option value="completed">Completed</option>
                    <option value="on-hold">On Hold</option>
                    <option value="dropped">Dropped</option>
                    <option value="plan-to-watch">Plan to Watch / Read</option>
                </select>

                <!-- Rating
                    - Uses <input type="number"
                    - step=0.5 allows halves -->
                <label for="rating">Rating (0-10) - Leave blank if you don't want to rate it yet.</label>
                <input
                    id="rating"
                    name="rating"
                    type="number"
                    min="0"
                    max="10"
                    step="0.5"
                    inputmode="decimal"
                    placeholder="e.g., 7.5 (optional)"
                />

                <!-- Notes -->
                <label for="notes">Notes</label>
                <textarea
                    id="notes"
                    placeholder="Thoughts...."
                    rows="5"
                ></textarea>

                <!-- Visible only in Add mode -->
                <div id="stayCheckboxContainer">
                    <label class="stayOnPageToggle">
                        <input type="checkbox" id="stayOnPageToggle" /> Stay on this page after adding
                    </label>
                </div>
                <!-- Aria live region for form status/errors -->
                <p id="formMsg" class="muted" aria-live="polite"></p>
                <button type="submit" id="submitBtn">Add Entry</button>
                <button type="button" id="cancelBtn">Cancel</button>
            </form>
        </main>

        <script>
            // Configure the API base URL once for all frontend calls.
            // Change the port to match Asp.Net app if needed
            window.APP_CONFIG = { apiBaseUrl: "https://localhost:7106"};
        </script>

        <!-- Auth guard + header account widget -->
        <script type="module">
            import {fetchMe, logout } from "./auth.js";

            const acctEmail = document.getElementById("acctEmail");
            const logoutBtn = document.getElementById("logoutBtn");

            async function initAccount() {
                try {
                    const me = await fetchMe();
                    acctEmail.textContent = me.email || me.userName || "(unknown)";
                } catch {
                    // If not logged in, bounce to login with return param to come back here
                    const here = location.href;
                    location.href = `login.html?return=${encodeURIComponent(here)}`;
                }
            }

            logoutBtn.addEventListener("click", () => {
                const here = location.href;
                logout();
                location.href = `login.html?return=${encodeURIComponent(here)}`;
            });

            initAccount();
        </script>

        <!-- Link to the JavaScript file-->
        <script type="module" src="entry.js"></script>
    </body>
</html>